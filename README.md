
# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'fp_win.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.
import datetime
import paramiko
import hashlib
import json
import random
import re
import socket
import time
import uuid
import mysql.connector
import pymysql
import requests
from PyQt5 import QtCore, QtWidgets,QtGui
import sys
import pymssql
from datetime import datetime, timedelta


class Ui_Dialog(object):
    head = {"Content-Type": "application/x-www-form-urlencoded",
            "Cookie": "XXL_JOB_LOGIN_IDENTITY=6333303830376536353837616465323835626137616465396638383162336437"}
    def setupUi(self, Dialog):
        Dialog.setObjectName("Dialog")
        Dialog.resize(1031, 506)
        self.pushButton = QtWidgets.QPushButton(Dialog)
        self.pushButton.setGeometry(QtCore.QRect(60, 40, 120, 51))
        self.pushButton.setObjectName("pushButton")
        self.pushButton.clicked.connect(self.get_log_range)
        self.textBrowser = QtWidgets.QTextBrowser(Dialog)
        self.lineEdit_1 = QtWidgets.QLineEdit(Dialog)
        self.lineEdit_1.setGeometry(QtCore.QRect(200, 40, 180, 51))
        self.textBrowser.setGeometry(QtCore.QRect(50, 100, 941, 361))
        self.textBrowser.setObjectName("textBrowser")
        self.pushButton_2 = QtWidgets.QPushButton(Dialog)
        self.pushButton_2.setGeometry(QtCore.QRect(800, 40, 121, 51))
        self.pushButton_2.setObjectName("pushButton_2")
        self.pushButton_2.clicked.connect(self.run_task)
        self.pushButton_3 = QtWidgets.QPushButton(Dialog)
        self.pushButton_3.setGeometry(QtCore.QRect(400, 40, 100, 51))
        self.pushButton_3.setObjectName("pushButton_2")
        self.pushButton_3.clicked.connect(self.connect_to_mysql)
        self.comboBox = QtWidgets.QComboBox(Dialog)
        self.comboBox.setGeometry(QtCore.QRect(600, 40, 191, 51))
        self.comboBox.setObjectName("comboBox")
        self.comboBox.addItem("万里牛-发货同步")
        self.comboBox.addItem("万里牛-售后同步")
        self.comboBox.addItem("快递鸟-签收同步")
        self.comboBox.addItem("core--初始账单")
        self.comboBox.addItem("core--余额打款")
        self.comboBox.addItem("core--现金打款")
        self.comboBox.addItem("core--打款查询")
        self.comboBox.addItem("订单推送活动及MQ")
        self.comboBox.addItem("同步分销商注册")
        self.comboBox.addItem("处理活动的启停")
        self.comboBox.addItem("活动扫描发放奖励")
        self.retranslateUi(Dialog)
        QtCore.QMetaObject.connectSlotsByName(Dialog)

    def retranslateUi(self, Dialog):
        _translate = QtCore.QCoreApplication.translate
        Dialog.setWindowTitle(_translate("Dialog", "契胜测试工具V2"))
        self.pushButton.setText(_translate("Dialog", "获取服务日志"))
        self.pushButton_2.setText(_translate("Dialog", "执行任务"))
        self.pushButton_3.setText(_translate("Dialog", "获取状态"))
        self.comboBox.setItemText(0, _translate("Dialog", "万里牛-发货同步"))
        self.comboBox.setItemText(1, _translate("Dialog", "万里牛-售后同步"))
        self.comboBox.setItemText(2, _translate("Dialog", "快递鸟-签收同步"))
        self.comboBox.setItemText(3, _translate("Dialog", "core--初始账单"))
        self.comboBox.setItemText(4, _translate("Dialog", "core--余额打款"))
        self.comboBox.setItemText(5, _translate("Dialog", "core--现金打款"))
        self.comboBox.setItemText(6, _translate("Dialog", "core--打款查询"))
        self.comboBox.setItemText(7, _translate("Dialog", "订单推送活动及MQ"))
        self.comboBox.setItemText(8, _translate("Dialog", "同步分销商注册"))
        self.comboBox.setItemText(9, _translate("Dialog", "处理活动的启停"))
        self.comboBox.setItemText(10, _translate("Dialog", "活动扫描发放奖励"))



    def get_today_range(self):
        # 获取当前日期
        today = datetime.today().date()

        # 构造当天开始时间和结束时间
        start_of_day = datetime.combine(today, datetime.min.time())
        end_of_day = start_of_day + timedelta(days=1) - timedelta(seconds=1)

        # 格式化为指定字符串格式
        start_str = start_of_day.strftime('%Y-%m-%d 00:00:00')
        end_str = end_of_day.strftime('%Y-%m-%d 23:59:59')

        return start_str + ' - ' + end_str



    def run_task(self):
        try:
            url='http://172.19.0.133:8080/xxl-job-admin/jobinfo/trigger'
            if self.comboBox.currentText()=="万里牛-发货同步":
                jobGroup=5
                id=25
                data={"id":25,
                      "executorParam":id}
            elif self.comboBox.currentText()=="万里牛-售后同步":
                jobGroup = 5
                id=26
                data={"id":26,
                      "executorParam":id}
            elif self.comboBox.currentText()=="快递鸟-签收同步":
                jobGroup = 5
                id=43
                data={"id":43,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--初始账单":
                jobGroup = 7
                id=41
                data={"id":41,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--余额打款":
                jobGroup = 7
                id=38
                data={"id":38,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--现金打款":
                jobGroup = 7
                id=40
                data={"id":40,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--打款查询":
                jobGroup = 7
                id=42
                data={"id":42,
                      "executorParam":id}
            elif self.comboBox.currentText()=="订单推送活动及MQ":
                jobGroup = 7
                id=55
                data={"id":55,
                      "executorParam":id}
            elif self.comboBox.currentText()=="同步分销商注册":
                jobGroup = 7
                id = 53
                data={"id":53,
                      "executorParam":id}
            elif self.comboBox.currentText()=="处理活动的启停":
                jobGroup = 7
                id = 52
                data={"id":52,
                      "executorParam":id}
            elif self.comboBox.currentText()=="活动扫描发放奖励":
                jobGroup = 7
                id = 51
                data={"id":51,
                      "executorParam":id}

            head={"Content-Type": "application/x-www-form-urlencoded",
                  "Cookie":"XXL_JOB_LOGIN_IDENTITY=6333303830376536353837616465323835626137616465396638383162336437"}
            task=requests.post(url,data=data,headers=head)
            task_code=task.json()["code"]
            time.sleep(2)
            url = 'http://172.19.0.133:8080/xxl-job-admin/joblog/pageList'

            data = {"jobGroup": jobGroup,
                    "jobId": id,
                    "logStatus": -1,
                    "filterTime": self.get_today_range(),
                    "start": 0,
                    "length": "10",
                    }

            status_log=requests.post(url,data=data,headers=head)
            code=status_log.json()['data'][0]['handleCode']
            while code==0 or code==500 or code is None:
                time.sleep(2)
                status_log = requests.post(url, data=data, headers=head)
                code = status_log.json()['data'][0]['handleCode']

            current_timestamp = int(time.time())

            if task_code==200 and code==200:
                self.textBrowser.append("任务执行成功{}".format(current_timestamp))
            else:
                self.textBrowser.append("任务执行失败{}".format(current_timestamp))



        except Exception as e:
            self.textBrowser.append(e)
        finally:
            self.textBrowser.append("********************")





    def get_log_range(self):
        # SSH 连接信息
        hostname = '172.19.0.128'
        port = 9998  # 默认 SSH 端口是 22
        username = 'root'
        password = 'ppxcx@123'

        # 创建 SSH 客户端对象
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

        order_no=self.lineEdit_1.text()
        try:
            # 连接服务器
            client.connect(hostname, port=port, username=username, password=password)

            # 执行远程命令示例，例如 grep -r 搜索日志文件
            command = "grep -r '\"masterOrderSn\":\"{}\"' /data/miya/order/logs/app".format(order_no)
            stdin, stdout, stderr = client.exec_command(command)

            # 读取命令输出
            output = stdout.read().decode()
            error = stderr.read().decode()

            # 打印输出结果
            if output:
                self.textBrowser.append("Command output:")
                self.textBrowser.append(output)
            if error:
                self.textBrowser.append("Command error:")
                self.textBrowser.append(error)

        finally:
            # 关闭 SSH 连接
            client.close()

    def connect_to_mysql(self):
        order_no = self.lineEdit_1.text()
        host = 'rm-bp1fts3bsss2x4q98qo.mysql.rds.aliyuncs.com'
        database = 'wuhan_kntn'
        port = 3637
        user = 'wuhan_kntn_test'
        password = 'wuhan_kn1tn_te@st'

        # 创建 MySQL 连接
        try:
            conn = mysql.connector.connect(
                host=host,
                database=database,
                port=port,
                user=user,
                password=password
            )

            if conn.is_connected():
                print('Connected to MySQL database')

                # 执行 SQL 查询
                cursor = conn.cursor()
                query = "SELECT bill_amount,bill_staus FROM ke_bill_info WHERE order_code='{}'".format(order_no)  # 替换为你的实际查询和表名

                cursor.execute(query)

                # 获取查询结果
                for (bill_amount, bill_staus) in cursor:
                    if bill_staus == 0:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''初始化状态:0')
                    elif bill_staus == 1:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''待打款:1')
                    elif bill_staus == 5:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''余额成功:5')
                    elif bill_staus == 4:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''现金成功:4')
                    elif bill_staus == 2:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''已打款:2')
                    else:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''未知状态:')

        except mysql.connector.Error as e:
            self.textBrowser.append(f'Error connecting to MySQL: {e}')

        finally:
            # 关闭连接
            if 'conn' in locals() and conn.is_connected():
                cursor.close()
                conn.close()
                self.textBrowser.append('MySQL connection closed')





    def dual_num(self, str):
            try:
                num = float(str)
            except Exception as e:
                num = 0
            return num


if __name__ == '__main__':
    app = QtWidgets.QApplication(sys.argv)
    MainWindow = QtWidgets.QWidget()
    ui = Ui_Dialog()
    ui.setupUi(MainWindow)
    MainWindow.show()
    sys.exit(app.exec_())








